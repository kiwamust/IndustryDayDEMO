name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # 自動レビュー用のイベント追加
  pull_request:
    types: [opened, synchronize, reopened]

# ★ ここで全ジョブを 1 本に直列化し、前ジョブをキャンセル
concurrency:
  group: claude-${{ github.repository }}
  cancel-in-progress: true

env:               # ★ Claude 共通の環境変数
  MAX_THINKING_TOKENS: "4096"
  CLAUDE_CODE_AUTO_COMPACT: "true"   # /compact を自動挿入

jobs:
  # ------------------------------------------------------------------
  # 既存の @claude メンション対応ジョブ
  # ------------------------------------------------------------------
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Claude[bot]"
          git config --global user.email "claude-bot@anthropic.com"

      # …▼ Parse / clone / pr ロジックはそのまま（省略）▼…
      # ここまで変更なし
      # -------------------------------------------------------------

      # Default Claude action
      - name: Run Claude Code
        if: steps.parse.outputs.action == 'claude'
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
        env:
          # ★ Claude 用リトライ設定
          RETRY_MAX: "3"
        continue-on-error: true      # ★ 失敗時に後続ステップで判定する

      # ★ 429 検出 → リトライ
      - name: Retry on 429
        if: steps.claude.outcome == 'failure'
        env:
          RETRY_MAX: 3
        run: |
          # Claude が書き出す JSON に conclusion があれば読む
          if grep -q '"rate_limited"' "$HOME/claude_execution_log.json" 2>/dev/null; then
            echo "⚠️ 429 detected – retrying"
            for i in $(seq 1 $RETRY_MAX); do
              # Claude の header ファイルがあれば retry-after を読む、なければ 10 秒
              WAIT=$(grep -o '"retry_after_seconds":[0-9]*' "$HOME/claude_execution_log.json" | grep -o '[0-9]*' || echo 10)
              echo "⌛ Sleep ${WAIT}s (attempt $i/$RETRY_MAX)…"
              sleep "$WAIT"
              gh run retry ${{ github.run_id }} || true
            done
          fi

  # ------------------------------------------------------------------
  # 制限付き自動コードレビュージョブ
  # ------------------------------------------------------------------
  auto-review:
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'opened' &&
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.title, 'WIP') &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # …▼ サイズチェックはそのまま ▼…

      - name: Run Lightweight Code Review
        if: steps.size-check.outputs.skip_review == 'false'
        id: auto-review
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            このPRの変更を簡潔にレビューしてください（最重要点のみ）：

            **チェック項目：**
            1. 🐛 **バグ・エラー** - 明らかなバグやエラーハンドリングの問題
            2. 🔒 **セキュリティ** - 脆弱性や機密情報漏洩リスク
            3. ⚡ **重大なパフォーマンス問題** - 明らかに非効率な実装

            **出力形式：**
            ## 🤖 簡易自動レビュー

            ### 🔴 修正必須項目
            [問題がある場合のみ記載]

            ### ✅ 確認完了
            - 基本的なバグチェック: OK
            - セキュリティチェック: OK  
            - パフォーマンスチェック: OK

            **総合:** [問題なし/要確認] 
            
            詳細レビューが必要な場合は `@claude 詳細レビュー` でリクエストしてください。
          allowed_tools: |
            Bash(git diff --name-only HEAD~1),
            Bash(git diff HEAD~1 --stat),
            View
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: 3