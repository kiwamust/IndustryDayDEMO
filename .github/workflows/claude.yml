name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
  pull_request:
    types: [opened, synchronize, reopened]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åŒæ™‚å®Ÿè¡Œã‚’ 1 æœ¬ã«æŠ‘ãˆã€å‰ã‚¸ãƒ§ãƒ–ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: claude-${{ github.repository }}
  cancel-in-progress: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Claude å…±é€šç’°å¢ƒå¤‰æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  MAX_THINKING_TOKENS: "4096"       # 1 å›ã‚ãŸã‚Š input ã‚’æŠ‘ãˆã‚‹
  CLAUDE_CODE_AUTO_COMPACT: "true"  # è‡ªå‹•ã§ /compact ã‚’æŒ¿å…¥

# ====================================================================
# 1) @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ã«ã—ãŸå€‹åˆ¥å¯¾å¿œã‚¸ãƒ§ãƒ–
# ====================================================================
jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      # --------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Claude[bot]"
          git config --global user.email "claude-bot@anthropic.com"

      # --------------------------------------------------------------
      # ã‚³ãƒ¡ãƒ³ãƒˆè§£æ â†’ action = clone | pr | claude ã‚’å‡ºåŠ›
      # --------------------------------------------------------------
      - name: Parse Claude Command
        id: parse
        shell: bash
        run: |
          COMMENT_BODY="${{ github.event.comment.body || github.event.issue.body || github.event.review.body }}"
          COMMAND=$(echo "$COMMENT_BODY" | grep -oP '@claude\s+\K.*' | head -n1)

          if echo "$COMMAND" | grep -q "^clone"; then
            echo "action=clone" >> "$GITHUB_OUTPUT"
            URL=$(echo "$COMMAND" | grep -oP 'clone\s+\K\S+')
            echo "clone_url=$URL" >> "$GITHUB_OUTPUT"
          elif echo "$COMMAND" | grep -q "^pr\s"; then
            echo "action=pr" >> "$GITHUB_OUTPUT"
            PR_TITLE=$(echo "$COMMAND" | grep -oP 'pr\s+"[^"]+' | sed 's/pr\s*"//')
            echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          else
            echo "action=claude" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------------------
      # clone ã‚³ãƒãƒ³ãƒ‰
      # --------------------------------------------------------------
      - name: Clone External Repository
        if: steps.parse.outputs.action == 'clone'
        shell: bash
        run: |
          CLONE_URL="${{ steps.parse.outputs.clone_url }}"
          if [ -z "$CLONE_URL" ]; then
            echo "::error ::No URL provided for clone command"
            exit 1
          fi

          REPO_NAME=$(basename -s .git "$CLONE_URL")
          git clone "$CLONE_URL" "external-repos/$REPO_NAME"

          BRANCH_NAME="clone-$REPO_NAME-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          git add "external-repos/$REPO_NAME"
          git commit -m "Clone external repository: $REPO_NAME"
          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "Clone: $REPO_NAME" \
            --body "This PR adds the cloned repository $REPO_NAME from $CLONE_URL" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------------------
      # pr ã‚³ãƒãƒ³ãƒ‰
      # --------------------------------------------------------------
      - name: Create Pull Request
        if: steps.parse.outputs.action == 'pr'
        shell: bash
        run: |
          PR_TITLE="${{ steps.parse.outputs.pr_title }}"
          [ -z "$PR_TITLE" ] && PR_TITLE="New feature"

          BRANCH_NAME="claude-pr-$(date +%s)"
          git checkout -b "$BRANCH_NAME"

          CONTEXT="${{ github.event.comment.body || github.event.issue.body }}"
          echo "dummy file" > claude_dummy_$(date +%s).txt
          git add .
          git commit -m "feat: $PR_TITLE"
          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "$PR_TITLE" \
            --body "Created by Claude based on request:\n\n$CONTEXT" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------------------
      # é€šå¸¸ã® Claude Code
      # --------------------------------------------------------------
      - name: Run Claude Code
        if: steps.parse.outputs.action == 'claude'
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
        continue-on-error: true       # å¤±æ•—æ™‚ã«ãƒªãƒˆãƒ©ã‚¤ã¸é€²ã¾ã›ã‚‹

      # --------------------------------------------------------------
      # 429 (rate_limit) ãŒå‡ºãŸã‚‰æœ€å¤§ 3 å›ã¾ã§ãƒªãƒˆãƒ©ã‚¤
      # --------------------------------------------------------------
      - name: Retry on 429
        if: steps.claude.outcome == 'failure'
        shell: bash
        env:
          RETRY_MAX: 3
        run: |
          LOG="$HOME/.claude_code/action_log.json"
          if [ ! -f "$LOG" ]; then
            echo "No log file; skip retry."
            exit 0
          fi

          if grep -q '"rate_limited"' "$LOG"; then
            WAIT=$(grep -o '"retry_after_seconds":[0-9]*' "$LOG" | grep -o '[0-9]*' | head -n1)
            [ -z "$WAIT" ] && WAIT=10
            for i in $(seq 1 "$RETRY_MAX"); do
              echo "ğŸ•’ Rate-limit retry $i/$RETRY_MAX â€“ wait ${WAIT}s"
              sleep "$WAIT"
              gh run retry ${{ github.run_id }} || true
            done
          else
            echo "No rate_limited message; not retrying."
          fi

# ====================================================================
# 2) ãƒ©ã‚¤ãƒˆã‚¦ã‚§ã‚¤ãƒˆè‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
# ====================================================================
  auto-review:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'opened' &&
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.title, 'WIP') &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PR ã‚µã‚¤ã‚ºè¨ˆæ¸¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check PR Size Limits
        id: size-check
        shell: bash
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
          echo "changed_files=$CHANGED_FILES" >> "$GITHUB_OUTPUT"

          if [ "$CHANGED_FILES" -gt 15 ]; then
            echo "skip_review=true"  >> "$GITHUB_OUTPUT"
            echo "reason=ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤šã™ãã¾ã™ ($CHANGED_FILES ãƒ•ã‚¡ã‚¤ãƒ«)" >> "$GITHUB_OUTPUT"
          else
            CHANGED_LINES=$(git diff --shortstat HEAD~1 | grep -o '[0-9]* insertion' | cut -d' ' -f1 || echo 0)
            if [ "$CHANGED_LINES" -gt 500 ]; then
              echo "skip_review=true"  >> "$GITHUB_OUTPUT"
              echo "reason=å¤‰æ›´è¡Œæ•°ãŒå¤šã™ãã¾ã™ ($CHANGED_LINES è¡Œ)" >> "$GITHUB_OUTPUT"
            else
              echo "skip_review=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚µã‚¤ã‚ºè¶…éæ™‚ã®é€šçŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post Size Limit Message
        if: steps.size-check.outputs.skip_review == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âš ï¸ **è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ**\n\nç†ç”±: ${{ steps.size-check.outputs.reason }}\n\nå¤§ããªå¤‰æ›´ã®ãŸã‚ã€æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚\nå¿…è¦ãªå ´åˆã¯ \`@claude ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦\` ã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚`
            });

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Claude ã«ã‚ˆã‚‹ç°¡æ˜“ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Lightweight Code Review
        if: steps.size-check.outputs.skip_review == 'false'
        id: auto-review
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã“ã®PRã®å¤‰æ›´ã‚’ç°¡æ½”ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæœ€é‡è¦ç‚¹ã®ã¿ï¼‰ï¼š

            **ãƒã‚§ãƒƒã‚¯é …ç›®ï¼š**
            1. ğŸ› **ãƒã‚°ãƒ»ã‚¨ãƒ©ãƒ¼** - æ˜ã‚‰ã‹ãªãƒã‚°ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œ  
            2. ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** - è„†å¼±æ€§ã‚„æ©Ÿå¯†æƒ…å ±æ¼æ´©ãƒªã‚¹ã‚¯  
            3. âš¡ **é‡å¤§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ** - æ˜ã‚‰ã‹ã«éåŠ¹ç‡ãªå®Ÿè£…  

            **å‡ºåŠ›å½¢å¼ï¼š**
            ## ğŸ¤– ç°¡æ˜“è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ### ğŸ”´ ä¿®æ­£å¿…é ˆé …ç›®
            [å•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿è¨˜è¼‰]

            ### âœ… ç¢ºèªå®Œäº†
            - åŸºæœ¬çš„ãªãƒã‚°ãƒã‚§ãƒƒã‚¯: OK
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: OK
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯: OK

            **ç·åˆ:** [å•é¡Œãªã—/è¦ç¢ºèª]

            è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ `@claude è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
          allowed_tools: |
            Bash(git diff --name-only HEAD~1),
            Bash(git diff HEAD~1 --stat),
            View
          timeout_minutes: 3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post Review Comment
        if: steps.auto-review.conclusion == 'success' && steps.size-check.outputs.skip_review == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const execFile = process.env.EXEC_FILE;
            let content = '';

            try {
              if (execFile && fs.existsSync(execFile)) {
                const log = JSON.parse(fs.readFileSync(execFile, 'utf8'));
                for (let i = log.length - 1; i >= 0; i--) {
                  if (log[i].role === 'assistant' && log[i].content) {
                    content = log[i].content;
                    break;
                  }
                }
              }
            } catch (e) {
              console.error('Failed to read execution file:', e);
            }

            if (content) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `${content}\n\n---\n**ğŸ¤– ç°¡æ˜“è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†** | è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼: \`@claude è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼\` | ã‚«ã‚¹ã‚¿ãƒ è³ªå•: \`@claude [è³ªå•å†…å®¹]\``
              });
            }
        env:
          EXEC_FILE: ${{ steps.auto-review.outputs.execution_file }}