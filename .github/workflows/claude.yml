name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # æ—¢å­˜ã®@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯¾å¿œã‚¸ãƒ§ãƒ–
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Claude[bot]"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Parse Claude Command
        id: parse
        run: |
          COMMENT_BODY="${{ github.event.comment.body || github.event.issue.body || github.event.review.body }}"
          
          # Extract command after @claude
          COMMAND=$(echo "$COMMENT_BODY" | grep -oP '@claude\s+\K.*' | head -n1)
          
          # Check for specific commands
          if echo "$COMMAND" | grep -q "^clone"; then
            echo "action=clone" >> $GITHUB_OUTPUT
            # Extract URL from clone command
            URL=$(echo "$COMMAND" | grep -oP 'clone\s+\K\S+')
            echo "clone_url=$URL" >> $GITHUB_OUTPUT
          elif echo "$COMMAND" | grep -q "^pr\s"; then
            echo "action=pr" >> $GITHUB_OUTPUT
            # Extract PR details
            PR_TITLE=$(echo "$COMMAND" | grep -oP 'pr\s+"[^"]+' | sed 's/pr\s*"//')
            echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          else
            echo "action=claude" >> $GITHUB_OUTPUT
          fi

      # Clone repository action
      - name: Clone External Repository
        if: steps.parse.outputs.action == 'clone'
        run: |
          CLONE_URL="${{ steps.parse.outputs.clone_url }}"
          if [ -z "$CLONE_URL" ]; then
            echo "Error: No URL provided for clone command"
            exit 1
          fi
          
          # Extract repo name from URL
          REPO_NAME=$(basename -s .git "$CLONE_URL")
          
          # Clone the repository
          git clone "$CLONE_URL" "external-repos/$REPO_NAME"
          
          # Create a new branch
          BRANCH_NAME="clone-$REPO_NAME-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Add cloned content
          git add "external-repos/$REPO_NAME"
          git commit -m "Clone external repository: $REPO_NAME"
          
          # Push to remote
          git push origin "$BRANCH_NAME"
          
          # Create PR
          gh pr create \
            --title "Clone: $REPO_NAME" \
            --body "This PR adds the cloned repository $REPO_NAME from $CLONE_URL" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create PR action
      - name: Create Pull Request
        if: steps.parse.outputs.action == 'pr'
        run: |
          PR_TITLE="${{ steps.parse.outputs.pr_title }}"
          if [ -z "$PR_TITLE" ]; then
            PR_TITLE="New feature"
          fi
          
          # Create a new branch
          BRANCH_NAME="claude-pr-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Get issue or comment context
          CONTEXT="${{ github.event.comment.body || github.event.issue.body }}"
          
          # Create PR using gh CLI
          gh pr create \
            --title "$PR_TITLE" \
            --body "Created by Claude based on request: $CONTEXT" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Default Claude action
      - name: Run Claude Code
        if: steps.parse.outputs.action == 'claude'
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"

  # åˆ¶é™ä»˜ãè‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–
  auto-review:
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'opened' &&
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.title, 'WIP') &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR Size Limits
        id: size-check
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # å¤§ããªå¤‰æ›´ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ "$CHANGED_FILES" -gt 15 ]; then
            echo "skip_review=true" >> $GITHUB_OUTPUT
            echo "reason=ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤šã™ãã¾ã™ ($CHANGED_FILES ãƒ•ã‚¡ã‚¤ãƒ«)" >> $GITHUB_OUTPUT
          else
            # å¤‰æ›´è¡Œæ•°ã‚‚ãƒã‚§ãƒƒã‚¯
            CHANGED_LINES=$(git diff --shortstat HEAD~1 | grep -o '[0-9]* insertion' | cut -d' ' -f1 || echo "0")
            if [ "$CHANGED_LINES" -gt 500 ]; then
              echo "skip_review=true" >> $GITHUB_OUTPUT
              echo "reason=å¤‰æ›´è¡Œæ•°ãŒå¤šã™ãã¾ã™ ($CHANGED_LINES è¡Œ)" >> $GITHUB_OUTPUT
            else
              echo "skip_review=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Post Size Limit Message
        if: steps.size-check.outputs.skip_review == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ**\n\n' +
                    'ç†ç”±: ${{ steps.size-check.outputs.reason }}\n\n' +
                    'å¤§ããªå¤‰æ›´ã®ãŸã‚ã€æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚\n' +
                    'å¿…è¦ãªå ´åˆã¯ `@claude ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦` ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚'
            });

      - name: Run Lightweight Code Review
        if: steps.size-check.outputs.skip_review == 'false'
        id: auto-review
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            ã“ã®PRã®å¤‰æ›´ã‚’ç°¡æ½”ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæœ€é‡è¦ç‚¹ã®ã¿ï¼‰ï¼š

            **ãƒã‚§ãƒƒã‚¯é …ç›®ï¼š**
            1. ğŸ› **ãƒã‚°ãƒ»ã‚¨ãƒ©ãƒ¼** - æ˜ã‚‰ã‹ãªãƒã‚°ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œ
            2. ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** - è„†å¼±æ€§ã‚„æ©Ÿå¯†æƒ…å ±æ¼æ´©ãƒªã‚¹ã‚¯
            3. âš¡ **é‡å¤§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ** - æ˜ã‚‰ã‹ã«éåŠ¹ç‡ãªå®Ÿè£…

            **å‡ºåŠ›å½¢å¼ï¼š**
            ## ğŸ¤– ç°¡æ˜“è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ### ğŸ”´ ä¿®æ­£å¿…é ˆé …ç›®
            [å•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿è¨˜è¼‰]

            ### âœ… ç¢ºèªå®Œäº†
            - åŸºæœ¬çš„ãªãƒã‚°ãƒã‚§ãƒƒã‚¯: OK
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: OK  
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯: OK

            **ç·åˆ:** [å•é¡Œãªã—/è¦ç¢ºèª] 
            
            è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ `@claude è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
          allowed_tools: "Bash(git diff --name-only HEAD~1),Bash(git diff HEAD~1 --stat),View"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: 3

      - name: Post Review Comment
        if: steps.auto-review.conclusion == 'success' && steps.size-check.outputs.skip_review == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let reviewContent = '';
            
            try {
              const executionFile = '${{ steps.auto-review.outputs.execution_file }}';
              if (fs.existsSync(executionFile)) {
                const executionLog = JSON.parse(fs.readFileSync(executionFile, 'utf8'));
                
                // Claude ã®æœ€æ–°ã®å›ç­”ã‚’å–å¾—
                for (let i = executionLog.length - 1; i >= 0; i--) {
                  if (executionLog[i].role === 'assistant' && executionLog[i].content) {
                    reviewContent = executionLog[i].content;
                    break;
                  }
                }
              }
            } catch (error) {
              console.error('Error reading execution file:', error);
            }
            
            // ç°¡æ½”ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            if (reviewContent) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reviewContent + '\n\n---\n' +
                      '**ğŸ¤– ç°¡æ˜“è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†** | ' +
                      'è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼: `@claude è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼` | ' +
                      'ã‚«ã‚¹ã‚¿ãƒ è³ªå•: `@claude [è³ªå•å†…å®¹]`'
              });
            }