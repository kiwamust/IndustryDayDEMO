name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # æ—¢å­˜ã®@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯¾å¿œã‚¸ãƒ§ãƒ–
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Claude[bot]"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Parse Claude Command
        id: parse
        run: |
          COMMENT_BODY="${{ github.event.comment.body || github.event.issue.body || github.event.review.body }}"
          
          # Extract command after @claude
          COMMAND=$(echo "$COMMENT_BODY" | grep -oP '@claude\s+\K.*' | head -n1)
          
          # Check for specific commands
          if echo "$COMMAND" | grep -q "^clone"; then
            echo "action=clone" >> $GITHUB_OUTPUT
            # Extract URL from clone command
            URL=$(echo "$COMMAND" | grep -oP 'clone\s+\K\S+')
            echo "clone_url=$URL" >> $GITHUB_OUTPUT
          elif echo "$COMMAND" | grep -q "^pr\s"; then
            echo "action=pr" >> $GITHUB_OUTPUT
            # Extract PR details
            PR_TITLE=$(echo "$COMMAND" | grep -oP 'pr\s+"[^"]+' | sed 's/pr\s*"//')
            echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          else
            echo "action=claude" >> $GITHUB_OUTPUT
          fi

      # Clone repository action
      - name: Clone External Repository
        if: steps.parse.outputs.action == 'clone'
        run: |
          CLONE_URL="${{ steps.parse.outputs.clone_url }}"
          if [ -z "$CLONE_URL" ]; then
            echo "Error: No URL provided for clone command"
            exit 1
          fi
          
          # Extract repo name from URL
          REPO_NAME=$(basename -s .git "$CLONE_URL")
          
          # Clone the repository
          git clone "$CLONE_URL" "external-repos/$REPO_NAME"
          
          # Create a new branch
          BRANCH_NAME="clone-$REPO_NAME-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Add cloned content
          git add "external-repos/$REPO_NAME"
          git commit -m "Clone external repository: $REPO_NAME"
          
          # Push to remote
          git push origin "$BRANCH_NAME"
          
          # Create PR
          gh pr create \
            --title "Clone: $REPO_NAME" \
            --body "This PR adds the cloned repository $REPO_NAME from $CLONE_URL" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create PR action
      - name: Create Pull Request
        if: steps.parse.outputs.action == 'pr'
        run: |
          PR_TITLE="${{ steps.parse.outputs.pr_title }}"
          if [ -z "$PR_TITLE" ]; then
            PR_TITLE="New feature"
          fi
          
          # Create a new branch
          BRANCH_NAME="claude-pr-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Get issue or comment context
          CONTEXT="${{ github.event.comment.body || github.event.issue.body }}"
          
          # Create PR using gh CLI
          gh pr create \
            --title "$PR_TITLE" \
            --body "Created by Claude based on request: $CONTEXT" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Default Claude action
      - name: Run Claude Code
        if: steps.parse.outputs.action == 'claude'
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"

  # æ–°è¦è¿½åŠ ï¼šè‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–
  auto-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Automatic Code Review
        id: auto-review
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’è©³ç´°ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
            ä»¥ä¸‹ã®è¦³ç‚¹ã§è©•ä¾¡ã—ã€å…·ä½“çš„ãªä¿®æ­£ææ¡ˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æä¾›ã—ã¦ãã ã•ã„ï¼š

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            1. **ğŸ› ãƒã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
               - æ½œåœ¨çš„ãªãƒã‚°ã‚„ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ç‰¹å®š
               - ä¾‹å¤–å‡¦ç†ã®ä¸å‚™ã‚„null/undefined ãƒã‚§ãƒƒã‚¯ã®æ¼ã‚Œ
               - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®

            2. **ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ª**
               - å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§
               - å‘½åè¦å‰‡ã®éµå®ˆ
               - ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã‚„ä¸è¦ãªè¤‡é›‘ã•
               - é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹ã®è²¬å‹™ã®æ˜ç¢ºæ€§

            3. **âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
               - éåŠ¹ç‡ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚„ã‚¯ã‚¨ãƒª
               - ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å¯èƒ½æ€§
               - ä¸è¦ãªè¨ˆç®—ã‚„APIå‘¼ã³å‡ºã—
               - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã®æœ€é©åŒ–

            4. **ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
               - XSSã€SQL injectionç­‰ã®è„†å¼±æ€§
               - èªè¨¼ãƒ»èªå¯ã®ä¸å‚™
               - æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ãƒªã‚¹ã‚¯
               - å…¥åŠ›å€¤æ¤œè¨¼ã®ç¢ºèª

            5. **âœ… ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**
               - è¨€èªãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å›ºæœ‰ã®æ…£ä¾‹
               - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©åˆ‡æ€§
               - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª
               - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã®å……å®Ÿåº¦

            ## å‡ºåŠ›å½¢å¼
            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            ### ğŸ“‹ ä¿®æ­£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            å„é …ç›®ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ãŸã‚‰ `- [x]` ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼š

            #### ğŸ”´ é«˜å„ªå…ˆåº¦ï¼ˆä¿®æ­£å¿…é ˆï¼‰
            - [ ] **ğŸ“ `[ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·]`** - [å•é¡Œã®è¦ç´„]
              - **å•é¡Œ:** [å…·ä½“çš„ãªå•é¡Œã®èª¬æ˜]
              - **ä¿®æ­£æ¡ˆ:** `[ä¿®æ­£å†…å®¹ã®è¦ç´„]`
              - **ç†ç”±:** [ä¿®æ­£ãŒå¿…è¦ãªç†ç”±]
              <details>
              <summary>ğŸ”§ ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹</summary>
              
              ```[è¨€èª]
              [ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ä¾‹]
              ```
              </details>

            #### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆä¿®æ­£æ¨å¥¨ï¼‰
            - [ ] **ğŸ“ `[ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·]`** - [å•é¡Œã®è¦ç´„]
              - **å•é¡Œ:** [å…·ä½“çš„ãªå•é¡Œã®èª¬æ˜]
              - **ä¿®æ­£æ¡ˆ:** `[ä¿®æ­£å†…å®¹ã®è¦ç´„]`
              - **ç†ç”±:** [ä¿®æ­£ãŒæ¨å¥¨ã•ã‚Œã‚‹ç†ç”±]

            #### ğŸŸ¢ ä½å„ªå…ˆåº¦ï¼ˆæ”¹å–„ææ¡ˆï¼‰
            - [ ] **ğŸ“ `[ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·]`** - [æ”¹å–„æ¡ˆã®è¦ç´„]
              - **ææ¡ˆ:** [å…·ä½“çš„ãªæ”¹å–„ææ¡ˆ]
              - **åŠ¹æœ:** [æ”¹å–„ã«ã‚ˆã‚‹åŠ¹æœ]

            ### âœ… è‰¯ã„å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ
            - âœ… [å…·ä½“çš„ãªè‰¯ã„å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ1]
            - âœ… [å…·ä½“çš„ãªè‰¯ã„å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ2]
            - âœ… [å…·ä½“çš„ãªè‰¯ã„å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ3]

            ### ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
            | é …ç›® | çµæœ |
            |------|------|
            | ğŸ”´ ä¿®æ­£å¿…é ˆ | [æ•°] ä»¶ |
            | ğŸŸ¡ ä¿®æ­£æ¨å¥¨ | [æ•°] ä»¶ |
            | ğŸŸ¢ æ”¹å–„ææ¡ˆ | [æ•°] ä»¶ |
            | **ç·åˆè©•ä¾¡** | **[ğŸ”´è¦ä¿®æ­£/ğŸŸ¡è¦æ¤œè¨/ğŸŸ¢æ‰¿èªå¯èƒ½]** |

            **ğŸ’¬ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:** [ç·åˆçš„ãªè©•ä¾¡ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹]

            **æ³¨æ„:** 
            - é‡è¦ãªå•é¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã€ã‚³ãƒ¼ãƒ‰ã®è‰¯ã„ç‚¹ã‚’ç©æ¥µçš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„
            - ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ä¿®æ­£å®Œäº†æ™‚ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦é€²æ—ã‚’ç®¡ç†ã—ã¦ãã ã•ã„
            - è³ªå•ãŒã‚ã‚‹å ´åˆã¯ `@claude [è³ªå•å†…å®¹]` ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„
          allowed_tools: "Bash(git diff --name-only HEAD~1),Bash(git diff HEAD~1),View,GlobTool,GrepTool"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: 10

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let reviewContent = '';
            
            if ('${{ steps.auto-review.outputs.conclusion }}' === 'success') {
              try {
                const executionFile = '${{ steps.auto-review.outputs.execution_file }}';
                if (fs.existsSync(executionFile)) {
                  const executionLog = JSON.parse(fs.readFileSync(executionFile, 'utf8'));
                  
                  // Claude ã®æœ€æ–°ã®å›ç­”ã‚’å–å¾—
                  for (let i = executionLog.length - 1; i >= 0; i--) {
                    if (executionLog[i].role === 'assistant' && executionLog[i].content) {
                      reviewContent = executionLog[i].content;
                      break;
                    }
                  }
                }
              } catch (error) {
                console.error('Error reading execution file:', error);
                reviewContent = '';
              }
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            if (reviewContent) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reviewContent + '\n\n---\n' +
                      '**ğŸ”„ è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¤ã„ã¦**\n' +
                      '- ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ\n' +
                      '- äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ä½µã›ã¦å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™\n' +
                      '- è³ªå•ã‚„è¿½åŠ ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ `@claude [è³ªå•å†…å®¹]` ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„'
              });
            } else {
              // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âš ï¸ **è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**\n\n' +
                      'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' +
                      'æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã™ã‚‹ã‹ã€`@claude ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦` ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚'
              });
            }